language: php

php:
  - 7.1

build:
  pre_ci:
    - mkdir -p /host/codecoverage
    - mkdir -p /host/testresults    
  
  pre_ci_boot:
    options: "-v /app:/app -v /host/codecoverage:/codecoverage -v /host/testresults:/testresults"
    
  ci:
    - cp -R . /app
    - pip install -U docker-compose
    - docker-compose up -d
    - sleep 10
    - docker exec docker-magento2_web_1 install-magento
    - docker exec docker-magento2_web_1 install-sampledata
    - mkdir -p shippable/codecoverage
    - mkdir -p shippable/testresults     
    - docker exec docker-magento2_web_1 /var/www/html/vendor/bin/phpunit --log-junit /testresults/junit.xml -c dev/tests/unit/phpunit.xml.dist
    - cp -R /codecoverage shippable/codecoverage
    - cp -R /testresults shippable/testresults
    - docker-compose down

