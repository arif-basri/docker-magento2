language: php

php:
  - 7.1

env:
  global:
    - TEST_RESULTS_DIR=$SHIPPABLE_REPO_DIR/shippable/testresults
    - CODE_COVERAGE_DIR=$SHIPPABLE_REPO_DIR/shippable/codecoverage
    - TESTS_LOC_DIR=$SHIPPABLE_REPO_DIR/tests
    - MOD_LOC=$SHIPPABLE_REPO_DIR/node_modules/.bin/
    - REGISTRY_URL=registry.hub.docker.com
    - IMAGE_REPO=magento3
    - PROJECT_NAME=firadaboss
    
build:  
  pre-ci:
    
  pre_ci_boot:
    options: "-v /app:/app"

  ci:
    - cp -R . /app    #copy checked out gitrepo from build container into build host for sharing with other containers spawned by the docker-compose    
    - docker-compose -p fv -f shippable/docker-compose-shippable.yml up -d web db
    - sleep 10
    - docker exec fv_web_1 install-magento
    #- docker exec fv_web_1 install-sampledata
    - docker exec fv_web_1 mkdir -p /app/testresults
    - docker exec fv_web_1 php -f /var/www/html/vendor/bin/phpunit -- --log-junit /app/testresults/junit.xml -c /var/www/html/dev/tests/unit/phpunit.xml.dist --filter ToolbarEntryTest

  post_ci:
    - cp -R /app/testresults/* $SHIPPABLE_BUILD_DIR/shippable/testresults/    #copy test result from host into build container
    - docker-compose -p fv -f shippable/docker-compose-shippable.yml down
    - docker tag drydock $REGISTRY_URL/$PROJECT_NAME/$IMAGE_REPO:$BRANCH.$BUILD_NUMBER
    - docker push $REGISTRY_URL/$PROJECT_NAME/$IMAGE_REPO:$BRANCH.$BUILD_NUMBER 
  
  on_failure:
    - cp -R /app/testresults/* $SHIPPABLE_BUILD_DIR/shippable/testresults/    #copy test result from host into build container
    - docker-compose -p fv -f shippable/docker-compose-shippable.yml down

notifications:
  email: false